# Carbone 模板格式设置指南

## 目标效果
- 首行缩进 2 个中文字符
- 合适的行距（1.5 倍或固定行距）
- 段落之间有适当间距
- 自动处理换行符

## 在 Microsoft Word 中设置模板格式

### 1. 首行缩进设置

选中包含 `{d.legal_opinion}` 等占位符的段落：

1. 右键 → **段落**
2. 在"缩进和间距"选项卡中：
   - **特殊格式**：选择"首行缩进"
   - **度量值**：设置为 2 字符（约 0.74 厘米）

或者使用快捷方式：
- 将光标放在段落中
- 按 `Ctrl + M`（增加缩进）
- 或在标尺上拖动首行缩进标记

### 2. 行距设置

在"段落"设置中：
- **行距**：选择"1.5 倍行距"或"固定值"（如 28 磅）
- **段前**：6 磅
- **段后**：6 磅

### 3. 换行符处理 ⚠️ **重要**

**代码已将文本按段落拆分为数组，模板中需要使用 Carbone 的数组迭代语法！**

#### 正确的占位符格式（使用数组迭代）：
```
一、基本事实

{d.basic_facts[i].text:convCRLF}

二、法律意见

{d.legal_opinion[i].text:convCRLF}

三、律师建议

{d.recommendations[i].text:convCRLF}
```

#### 重要说明：
- ✅ `[i]` 语法告诉 Carbone 这是一个数组，需要迭代生成多个段落
- ✅ 每个数组元素会生成一个独立的 Word 段落（`<w:p>`）
- ✅ `:convCRLF` 格式化器会将段落内的单个 `\n` 转换为 Word 段内换行（`<w:br/>`）
- ✅ 段落之间会自动有间距（继承模板的段落格式）
- ⚠️ **必须使用数组语法** `{d.field[i].text}` 而不是 `{d.field}`

#### 如何更新模板：
1. 打开 `legal-memo-carbone.docx`
2. 找到占位符 `{d.basic_facts}`, `{d.legal_opinion}`, `{d.recommendations}`
3. 将它们分别改为：
   - `{d.basic_facts[i].text:convCRLF}`
   - `{d.legal_opinion[i].text:convCRLF}`
   - `{d.recommendations[i].text:convCRLF}`
4. 确保占位符所在段落已设置好首行缩进（2字符）和行距
5. 保存模板

### 4. 样式设置（推荐）

为了保持一致性，可以创建样式：

1. 选中格式化好的段落
2. 右键 → **样式** → **创建样式**
3. 命名为"正文"或"法律意见正文"
4. 将此样式应用到所有内容段落

### 5. 高级：使用 Carbone 格式化标记（可选）

如果需要更精细的控制，可以使用 Carbone 的格式化器：

- `{d.legal_opinion:nl2br}` - 将 \n 转换为硬回车
- `{d.legal_opinion:keepNewLine}` - 保留换行符

通常情况下，默认行为已足够，无需使用这些标记。

## 测试模板

保存模板后，运行测试脚本：
```bash
cd /Users/dongli/Workspace/LexDocEngine/packages/backend
bun run test-carbone-docx.ts
```

用 Word 打开生成的测试文件，检查格式是否符合预期。

## 常见问题

### Q: 首行缩进没有生效？
A: 确保占位符所在段落设置了首行缩进，而不是整个文档。选中段落后再设置。

### Q: 段落之间没有间距？
A: 在段落设置中增加"段后"间距，推荐 6-12 磅。

### Q: 文本全部连在一起，没有分段？
A: 确认 AI 生成的内容包含 `\n` 换行符。检查后端日志中的内容预览。

### Q: 想要每段自动编号（一）（二）（三）？
A: 让 AI 生成时就包含编号（已在新提示词中要求）。或使用 Word 的自动编号功能。
