# Word 模板更新指南 - 支持段落数组

## 问题背景

导出的 Word 文档中，所有内容显示为一段，没有换行和段落分隔。原因是代码已经将文本按 `\n\n` 拆分为段落数组，但模板中还在使用简单的占位符格式。

## 解决方案

更新模板使用 Carbone 的数组迭代语法，让每个段落生成独立的 Word 段落。

## 具体步骤

### 1. 打开模板文件

用 Microsoft Word 打开：
```
/Users/dongli/Workspace/LexDocEngine/packages/backend/templates/legal-memo-carbone.docx
```

### 2. 查找并替换占位符

找到以下三个占位符，并按照下表进行替换：

| 原占位符 | 新占位符 |
|---------|---------|
| `{d.basic_facts}` | `{d.basic_facts[i].text:convCRLF}` |
| `{d.legal_opinion}` | `{d.legal_opinion[i].text:convCRLF}` |
| `{d.recommendations}` | `{d.recommendations[i].text:convCRLF}` |

### 3. 设置段落格式（重要！）

**为每个占位符所在的段落设置格式：**

1. 选中包含占位符的段落
2. 右键 → **段落**
3. 在"缩进和间距"选项卡中设置：
   - **首行缩进**：2 字符
   - **行距**：1.5 倍行距
   - **段前**：6 磅
   - **段后**：6 磅
4. 点击"确定"

**为什么这样设置？**
- `[i]` 语法会让 Carbone 迭代数组，为每个元素创建一个新的 Word 段落
- 每个新段落会**继承模板中占位符所在段落的格式**
- 因此，模板中的首行缩进、行距等格式会自动应用到所有生成的段落

### 4. 保存模板

按 `Cmd + S` 保存模板文件。

## 技术说明

### Carbone 数组迭代语法

```
{d.array_name[i].field_name:formatter}
```

- `d.array_name`: 数据对象中的数组字段名
- `[i]`: 迭代标记，Carbone 会为数组中的每个元素生成一个段落
- `.field_name`: 数组元素的属性名（我们的元素是 `{text: string}` 结构）
- `:convCRLF`: 可选的格式化器，将段落内的 `\n` 转换为 Word 行内换行符

### 数据结构

代码中 `export.ts` 的 `textToParagraphs()` 函数会将文本转换为：

```typescript
// 输入文本
"（一）法律关系分析\n本案涉及...\n\n（二）法律适用分析\n根据相关法律..."

// 输出数组
[
  { text: "（一）法律关系分析\n本案涉及..." },
  { text: "（二）法律适用分析\n根据相关法律..." }
]
```

### 段落内换行 vs 段落间分隔

- **双换行 `\n\n`**: 在代码中被拆分为两个数组元素，生成两个独立的 Word 段落（段落之间有间距）
- **单换行 `\n`**: 保留在 `text` 字段内，由 `:convCRLF` 转换为 Word 行内换行 `<w:br/>`

## 测试验证

更新模板后，运行测试脚本验证：

```bash
cd /Users/dongli/Workspace/LexDocEngine/packages/backend
bun run test-carbone-docx.ts
```

用 Word 打开生成的 `test-output-docx.docx`，检查：
- ✅ 每个（一）（二）（三）标题都是独立的段落
- ✅ 段落之间有适当间距
- ✅ 每段开头有 2 字符的首行缩进
- ✅ 行距为 1.5 倍

## 常见问题

### Q: 更新后还是没有段落分隔？
A: 检查是否正确添加了 `[i]` 标记。确保格式为 `{d.legal_opinion[i].text:convCRLF}`

### Q: 首行缩进没有生效？
A: 确保在模板中为**占位符所在的段落**设置了首行缩进，而不是整个文档。

### Q: 段落内的换行丢失了？
A: 确保添加了 `:convCRLF` 格式化器。这个格式化器会将 `\n` 转换为 Word 的行内换行。

### Q: 我想调整段落间距？
A: 在模板中调整占位符所在段落的"段前"和"段后"间距。所有生成的段落都会继承这个设置。
